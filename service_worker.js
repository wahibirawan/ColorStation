import{M as a,D as i}from"./chunks/constants.js";const c="settings",d="history",w=()=>globalThis.crypto?.randomUUID?globalThis.crypto.randomUUID():`${Date.now()}-${Math.random().toString(16).slice(2)}`,b=t=>!t||typeof t!="object"?{...i}:{...i,...t},l=async()=>{const t=await chrome.storage.local.get(c);return b(t[c])},m=async t=>{const r={...await l(),...t};return await chrome.storage.local.set({[c]:r}),r},y=async()=>{const e=(await chrome.storage.local.get(d))[d];return Array.isArray(e)?e.filter(r=>r&&typeof r.id=="string"&&typeof r.hex=="string"&&typeof r.rgb=="string"&&typeof r.hsl=="string"&&typeof r.createdAt=="number"):[]},u=async t=>{const e=t.slice(0,a);return await chrome.storage.local.set({[d]:e}),e},T=async t=>{const e=await y(),r=e.find(n=>n.hex.toUpperCase()===t.hex.toUpperCase()),o=[{id:w(),hex:t.hex,rgb:t.rgb,hsl:t.hsl,pinned:r?.pinned??!1,createdAt:Date.now()},...e.filter(n=>n.id!==r?.id)].slice(0,a);return u(o)},S=async(t,e)=>{const s=(await y()).map(o=>o.id!==t?o:{...o,pinned:e});return u(s)},g=async()=>{const[t,e]=await Promise.all([l(),y()]);return{settings:t,history:e}},p=t=>t instanceof Error?t.message:String(t),I=async()=>{const t=await chrome.storage.local.get(["settings","history"]),e={};(!t.settings||typeof t.settings!="object")&&(e.settings=i),Array.isArray(t.history)?t.history.length>a&&(e.history=t.history.slice(0,a)):e.history=[],Object.keys(e).length>0&&await chrome.storage.local.set(e)},E=async()=>{const e=(await chrome.tabs.query({active:!0,currentWindow:!0}))[0];if(!e||e.id===void 0)throw new Error("No active tab found.");return e},A=t=>{const e=p(t);return e.includes("Could not establish connection")||e.includes("Receiving end does not exist")},h=async(t,e)=>{const r=await g();await chrome.tabs.sendMessage(t,{type:"FAST_COLOR_PICKER_START",payload:{mode:e,settings:r.settings,history:r.history}})},f=async(t,e)=>{try{await h(t,e);return}catch(r){if(!A(r))throw r}await chrome.scripting.executeScript({target:{tabId:t},files:["content_script.js"]}),await h(t,e)},_=async t=>{const r=(await E()).id;await f(r,t)},k=async t=>{const e=t.tab?.windowId;return typeof e=="number"?chrome.tabs.captureVisibleTab(e,{format:"png"}):chrome.tabs.captureVisibleTab({format:"png"})},v=async(t,e)=>{switch(t.type){case"GET_STATE":{const r=await g();return{ok:!0,settings:r.settings,history:r.history}}case"UPDATE_SETTINGS":return{ok:!0,settings:await m(t.payload??{})};case"ADD_HISTORY_COLOR":{if(!t.payload||typeof t.payload!="object")throw new Error("Invalid color payload.");const{hex:r,rgb:s,hsl:o}=t.payload;if(!r||!s||!o)throw new Error("Incomplete color payload.");return{ok:!0,history:await T({hex:r,rgb:s,hsl:o})}}case"TOGGLE_HISTORY_PIN":{const{id:r,pinned:s}=t.payload??{};if(!r||typeof s!="boolean")throw new Error("Invalid pin payload.");return{ok:!0,history:await S(r,s)}}case"CAPTURE_VISIBLE_TAB":return{ok:!0,dataUrl:await k(e)};default:return{ok:!1,error:"Unknown message type."}}};chrome.runtime.onInstalled.addListener(()=>{I()});chrome.commands.onCommand.addListener(t=>{t==="start-picker"&&_("capture").catch(()=>{})});chrome.action.onClicked.addListener(t=>{t.id!==void 0&&f(t.id,"capture").catch(()=>{})});chrome.runtime.onMessage.addListener((t,e,r)=>(v(t,e).then(s=>r(s)).catch(s=>{r({ok:!1,error:p(s)})}),!0));
